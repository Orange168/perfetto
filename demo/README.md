# Perfetto架构演示

这个演示项目模拟了Perfetto追踪框架的核心架构，包含以下组件：

## 架构概览

### 1. 核心组件

- **服务层 (Service)**: 中央协调者，管理生产者和消费者
- **生产者 (Producer)**: 数据源提供者，将追踪数据写入共享内存
- **消费者 (Consumer)**: 控制追踪会话，读取追踪数据
- **数据源 (DataSource)**: 实际产生跟踪数据的组件

### 2. 通信机制

- **IPC通信**: 使用套接字（Windows下为命名管道）实现跨进程通信
- **共享内存池**: 高效传输大量数据，避免复制开销
- **追踪缓冲区**: 环形缓冲区记录数据

### 3. 多线程模型

- **生产者线程**: 命令处理线程和数据源线程
- **服务线程**: 接收线程和客户端处理线程
- **消费者线程**: 命令线程和响应处理线程

## 构建和运行

### 依赖项

- C++17兼容的编译器
- pthread库
- make工具

### 构建步骤

```bash
# 构建项目
cd demo
make

# 运行演示
./perfetto_demo
```

## 代码结构

```
demo/
├── include/               # 头文件
│   ├── core/              # 核心定义（数据源等）
│   ├── ipc/               # IPC通信
│   ├── memory/            # 共享内存实现
│   ├── producer/          # 生产者API
│   ├── service/           # 服务实现
│   └── consumer/          # 消费者API
├── src/                   # 源文件
│   ├── core/
│   ├── ipc/
│   ├── memory/
│   ├── producer/
│   ├── service/
│   └── consumer/
├── main.cpp               # 演示程序
├── Makefile               # 构建系统
└── README.md              # 项目文档
```

## 使用示例

演示程序 `main.cpp` 展示了如何使用该框架:

1. 创建一个服务实例
2. 创建生产者并注册自定义数据源
3. 创建消费者并配置追踪会话
4. 启动追踪和收集数据
5. 读取和处理追踪结果

这个演示简化了一些复杂的部分，但保留了Perfetto核心架构的主要概念。

## 扩展方向

- 添加更多数据源类型
- 实现数据的序列化和反序列化
- 添加更丰富的追踪配置选项
- 实现追踪数据解析和可视化 